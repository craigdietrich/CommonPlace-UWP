<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>CommonPlace</title>
<meta name="author" content="http://craigdietrich.com">
<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
<link rel="stylesheet" href="common/css/bootstrap.min.css">
<link rel="stylesheet" href="common/css/jqbtk.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Exo">
<link rel="stylesheet" href="common/css/crossroads.css">
<link rel="stylesheet" href="common/css/main.css">
<script src="common/js/jquery-3.2.1.min.js"></script>
<script src="common/js/popper.min.js"></script>
<script src="common/js/bootstrap.min.js"></script>
<script src="common/js/jstorage.min.js"></script>
<script src="common/js/jqbtk.js"></script>
<script src="common/js/jquery.textfill.min.js"></script>
<script src="common/js/hammer.min.js"></script>
<script src="common/js/jquery.crossroads.js"></script>
<script>
$(document).ready(function() {
    // Set the iframe height to account for the height of the nav
    var iframe_height = function () {
        $('#site').height(parseInt($(window).height()) - parseInt($('#nav').height()));
    };
    iframe_height();
    $(window).resize(iframe_height);
    // Messages from the auto-navigate plugin
    window.addEventListener("message", function (event) {
        switch (event.data) {
            case 'autonavigate_finished':
                animate_next_project();
                break;
            case 'autonavigate_click':
                break;
            case 'autonavigate_user_interaction':
                break;
        }
    }, false);
    // Set globals
    paths = [];
    path_index = 1;
    project_index = -1;
    global_stop_timer = false;
    // Determine the data source
    var source = $.jStorage.get('commonplace_source');
    if (!source && 'undefined' != typeof (app_info) && 'undefined' != typeof (app_info.default_source)) source = app_info.default_source;
    source = 'http://scalar.cdla.oxycreates.org/commonplace';
    if (!source) {
        $('#logo-wrapper button').removeClass('btn-light').addClass('btn-secondary');
        advanced_options();
        return;
    };
    // Go get the paths and start the application
    get_paths(source, function (_paths) {
        paths = _paths.slice();
        console.log(paths);
        path_index = get_path_index();
        console.log('path_index: ' + path_index);
        set_panel();
        $('#nav').fadeTo('slow', 1, function () {
            animate_next_project();
        });
    });
});
// Get info about the app
function set_app_vars(version_num, authors, short_description, long_description, default_source) {
    app_info = {};  // Global
    app_info.version_num = version_num;
    app_info.authors = authors;
    app_info.short_description = short_description;
    app_info.long_description = long_description;
    app_info.default_source = default_source;
};
// Sort paths by title
function path_compare(a,b) {
    if (a.title < b.title) return -1;
    if (a.title > b.title) return 1;
    return 0;
};
// Go get the paths from a Scalar book and build an array of paths and projects
function get_paths(url, callback) {
    var is_google_spreadsheet = (-1 != url.indexOf('google.com')) ? true : false;
    if (is_google_spreadsheet) {  // Google Spreadsheet
        var spreadsheet_id = new RegExp("/spreadsheets/d/([a-zA-Z0-9-_]+)").exec(url)[1];
        var google_spreadsheet_url = 'https://spreadsheets.google.com/feeds/cells/' + spreadsheet_id + '/1/public/values?alt=json-in-script&callback=?';
        $.getJSON(google_spreadsheet_url, function (data) {
            var fields = [];
            var rows = {};
            var paths = []
            for (var j = 0; j < data.feed.entry.length; j++) {
                if (data.feed.entry[j]["gs$cell"].row == 1) {
                    fields.push(data.feed.entry[j].content["$t"]);
                } else {
                    var col_index = data.feed.entry[j]["gs$cell"].col - 1;
                    var row_num = data.feed.entry[j]["gs$cell"].row;
                    var fieldname = fields[col_index];
                    var value = data.feed.entry[j].content["$t"];
                    console.log(row_num);
                    if ('undefined' == typeof (rows[row_num])) rows[row_num] = {};
                    rows[row_num][fieldname] = value;
                };
            };
            for (var j in rows) {
                rows[j]['Path name(s)'] = rows[j]['Path name(s)'].split(';');
            };
            for (var j in rows) {
                for (var k = 0; k < rows[j]["Path name(s)"].length; k++) {
                    var exists = false;
                    for (var m = 0; m < paths.length; m++) {
                        if (paths[m].title == rows[j]["Path name(s)"][k]) exists = true;
                    };
                    if (!exists) {
                        var path = {};
                        path.title = rows[j]["Path name(s)"][k];
                        path.desc = '';
                        path.contents = [];
                        paths.push(path);
                    }
                };
            };
            for (var j in rows) {
                for (var k = 0; k < rows[j]["Path name(s)"].length; k++) {
                    var pathname = rows[j]["Path name(s)"][k];
                    var content = {};
                    content.title = ('undefined' != typeof (rows[j]["dcterms:title"])) ? rows[j]["dcterms:title"] : null;
                    content.description = ('undefined' != typeof (rows[j]["dcterms:description"])) ? rows[j]["dcterms:title"] : null;
                    content.content = ('undefined' != typeof (rows[j]["sioc:content"])) ? rows[j]["sioc:content"] : null;
                    content.thumb = ('undefined' != typeof (rows[j]["art:thumbnail"])) ? rows[j]["art:thumbnail"] : null;
                    content.url = ('undefined' != typeof (rows[j]["cp:url"])) ? rows[j]["cp:url"] : null;
                    content.authors = ('undefined' != typeof (rows[j]["cp:authors"])) ? rows[j]["cp:authors"] : null;
                    content.institution = ('undefined' != typeof (rows[j]["cp:institution"])) ? rows[j]["cp:institution"] : null;
                    content.publisher = ('undefined' != typeof (rows[j]["cp:publisher"])) ? rows[j]["cp:publisher"] : null;
                    content.date = ('undefined' != typeof (rows[j]["cp:date"])) ? rows[j]["cp:date"] : null;
                    for (var m = 0; m < paths.length; m++) {
                        if (paths[m].title == pathname) paths[m].contents.push(content);
                    };
                };
            };
            paths.sort(path_compare);
            callback(paths);
        });
    } else {  // Scalar
        if ('/' != url.substr(-1)) url += '/';
        var paths = [];
        var parsed = [];
        $.ajax({
            url: url + 'rdf/instancesof/path?rec=1&format=json&t=' + (new Date().getTime()),
            jsonp: "callback",
            dataType: "jsonp",
            format: 'json',
            success: function (response) {
                for (var uri in response) {
                    var path = {};
                    if ('http://www.openannotation.org/ns/Annotation' != response[uri]['http://www.w3.org/1999/02/22-rdf-syntax-ns#type'][0].value) continue;
                    path.version_uri = response[uri]['http://www.openannotation.org/ns/hasBody'][0].value;
                    path.content_uri = version_uri_to_content_uri(path.version_uri);
                    if (-1 != parsed.indexOf(path.content_uri)) continue;
                    parsed.push(path.content_uri);
                    path.title = response[path.version_uri]['http://purl.org/dc/terms/title'][0].value;
                    path.desc = ('undefined' != typeof (response[path.version_uri]['http://purl.org/dc/terms/description'])) ? response[path.version_uri]['http://purl.org/dc/terms/description'][0].value : null;
                    path.contents = [];
                    for (var key in response) {
                        if ('http://www.openannotation.org/ns/Annotation' != response[key]['http://www.w3.org/1999/02/22-rdf-syntax-ns#type'][0].value) continue;
                        if (path.version_uri != response[key]['http://www.openannotation.org/ns/hasBody'][0].value) continue;
                        var content = {};
                        content.target = response[key]['http://www.openannotation.org/ns/hasTarget'][0].value;
                        content.version_uri = content.target.substr(0, content.target.lastIndexOf('#'));
                        content.content_uri = version_uri_to_content_uri(content.version_uri);
                        content.index = parseInt(content.target.substr(content.target.indexOf('index=') + 6));
                        content.title = response[content.version_uri]['http://purl.org/dc/terms/title'][0].value;
                        content.description = ('undefined' != typeof (response[content.version_uri]['http://purl.org/dc/terms/description'])) ? response[content.version_uri]['http://purl.org/dc/terms/description'][0].value : null;
                        content.content = ('undefined' != typeof (response[content.version_uri]['http://rdfs.org/sioc/ns#content'])) ? response[content.version_uri]['http://rdfs.org/sioc/ns#content'][0].value : null;
                        content.thumb = ('undefined' != typeof (response[content.content_uri]['http://simile.mit.edu/2003/10/ontologies/artstor#thumbnail'])) ? response[content.content_uri]['http://simile.mit.edu/2003/10/ontologies/artstor#thumbnail'][0].value : null;
                        if (!content.thumb) content.thumb = 'http://scalar.cdla.oxycreates.org/system/application/views/modules/oxy_book_list/common/images/default_book_logo.png';
                        content.url = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/url'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/url'][0].value : null;
                        content.short_url = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/shortUrl'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/shortUrl'][0].value : '(no url)';
                        content.authors = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/authors'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/authors'][0].value : null;
                        content.institution = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/institution'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/institution'][0].value : null;
                        content.publisher = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/publisher'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/publisher'][0].value : null;
                        content.date = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/date'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/date'][0].value : null;
                        content.slideDeckNumSlides = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/slideDeckNumSlides'])) ? parseInt(response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/slideDeckNumSlides'][0].value) : 0;
                        content.slideDeckSecondsPerSlide = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/slideDeckSecondsPerSlide'])) ? parseInt(response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/slideDeckSecondsPerSlide'][0].value) : 0;
                        path.contents.push(content);
                    };
                    paths.push(path);
                };
                paths.sort(path_compare);
                callback(paths);
            },
            error: function (err) {
                console.log(err);
                callback(paths);
            }
        });
    };
};
// Get the path index either from localStorage or default to the first path
function get_path_index() {
    var index = $.jStorage.get('commonplace_path_index', 0);
    return index;
}
// Go to the next project on the path
function prev_project() {
	project_index--;
	if ('undefined'==typeof(paths[path_index].contents[project_index])) project_index = 0;
	go_to_site(paths[path_index].contents[project_index].url);
	set_panel();
};
// Go to the previous project on the path
function next_project() {
	project_index++;
	if ('undefined'==typeof(paths[path_index].contents[project_index])) project_index = 0;
	go_to_site(paths[path_index].contents[project_index].url);
	set_panel();
};
// Go to the next project but first visit the panel and select the next project
function animate_next_project(step) {
    if ('undefined' == typeof(step)) step = 1;
    switch (step) {
        case 1:
            if ($('#panel').is(':visible') || $('.modal.show').length) return;
            $('#logo-wrapper').mousedown();
            setTimeout(function () {
                animate_next_project(2);
            }, 9000);
            break;
        case 2:
            if (!$('#panel').is(':visible') || $('.modal.show').length) return;
            if ($('#panel').find('.col.hl').length) {
                var index = 0;
                var total = 0;
                $('#panel').find('.col:not(.empty):not(.path-title)').each(function (_index) {
                    if ($(this).hasClass('hl')) index = _index;
                    total++;
                });
                var $this = $('#panel').find('.col:not(.empty):not(.path-title)').eq(index);
                $this.removeClass('hl');
                if (index < total - 1) {
                    $('#panel').find('.col:not(.empty):not(.path-title)').eq(index + 1).addClass('hl');
                } else {
                    $('#panel').find('.row:not(:first)').eq(0).find('.col').eq(0).addClass('hl');
                };
            } else {
                $('#panel').find('.row:not(:first)').eq(0).find('.col').eq(0).addClass('hl');
            };
            var $el = $('#panel').find('.col.hl').eq(0);
            var scrollHeight = parseInt($('#panel')[0].scrollHeight);
            var totalScroll = scrollHeight - parseInt($('#panel').height());
            var vertBuffer = parseInt($('#nav').height()) * 2;
            var relativePosition = parseInt($el.position().top) + parseInt($el.height()) + vertBuffer + parseInt($('#panel')[0].scrollTop);
            var scrollTop = 0;
            if (relativePosition > parseInt($('#panel').height())) {
                scrollTop = relativePosition - parseInt($('#panel').height());
                if (scrollTop > totalScroll) scrollTop = totalScroll;
            }
            console.log('relativePosition: ' + relativePosition + ' panel height: ' + $('#panel').height()+' scrollTop: ' + scrollTop + ' totalScroll ' + totalScroll);
            $('#panel').animate({
                scrollTop: scrollTop
            }, 2000, function () {
                setTimeout(function () {
                    animate_next_project(3);
                }, 2000);
            });
            break;
        case 3:
            if (!$('#panel').is(':visible') || $('.modal.show').length) return;
            $('#panel').find('.col.hl').click();
            break;
    };
};
// Determine the platform and load the project
function go_to_site(_url) {
    var _scalar = function (response, url) {
        for (var uri in response) break;
        if ('undefined'==typeof(response[uri]['http://purl.org/dc/terms/isPartOf'])) {
        	alert('Scalar: could not find dcterms:isPartOf field for '+url);
        	return;
        }
        var system = response[uri]['http://purl.org/dc/terms/isPartOf'][0].value;
        var plugin = system + 'system/application/plugins/auto-navigate/index.html?book='+url.replace(system,'')+'&t='+(new Date().getTime());
        $('#site').fadeIn('slow').attr('src', plugin);
        set_buttons(
            '<button class="btn btn-light">About project</button>',
            '<button class="btn btn-light">Email project</button>',
            function (col) {
                $(col).find('button').on('mousedown', function() {
                    about_project();
                });
            },
            function (col) {
                $(col).find('button').on('click', function() {
                    send_email();
                });
            }
        );
	};
	var _omeka = function(url) {
		var plugin = url + '/plugins/AutoNavigate/index.html?t='+(new Date().getTime());
        $('#site').fadeIn('slow').attr('src', plugin);
        set_buttons(
            '<button class="btn btn-light">About project</button>',
            '<button class="btn btn-light">Email project</button>',
            function (col) {
                $(col).find('button').on('mousedown', function() {
                    about_project();
                });
            },
            function (col) {
                $(col).find('button').on('click', function() {
                    send_email();
                });
            }
        );
	};
    var _crossroads = function (url) {
        $('#site').attr('src', '');
        if ('undefined' == typeof (crossroads_projects)) crossroads_projects = null;  // Global
        if (null == crossroads_projects) {
            $.fn.crossroads('get_projects', function(project_list) {
                crossroads_projects = project_list.slice();
                _crossroads(url);
            });
            return;
        };
        var $crossroads = $('<div id="crossroads" data-url="' + url + '"></div>').insertAfter('#site');
        $crossroads.crossroads({
            title: paths[path_index].contents[project_index].title,
            authors: paths[path_index].contents[project_index].authors,
            url: _url,
            projects: crossroads_projects
        });
        set_buttons(
            '<button class="btn btn-light">About project</button>',
            '<button class="btn btn-light">Email project</button>',
            function (col) {
                $(col).find('button').on('mousedown', function() {
                    about_project();
                });
            },
            function (col) {
                $(col).find('button').on('click', function () {
                    send_email();
                });
            }
        );
    };
    var _googleslides = function (url) {
        var $site = $('#site');
        $site.fadeIn('slow').off('load').on('load', function () {
            var $custom = $('<div class="custom_msg"></div>').insertAfter($site).hide();
            $custom.html('<b>' + paths[path_index].contents[project_index].title + '</b> by ' + paths[path_index].contents[project_index].authors);
            $custom.fadeIn('slow');
        }).attr('src', url);
        var the_time = (paths[path_index].contents[project_index].slideDeckNumSlides + 1) * paths[path_index].contents[project_index].slideDeckSecondsPerSlide;
        the_time = the_time + Math.round((paths[path_index].contents[project_index].slideDeckNumSlides + 1) * 0.4);
        reset_timer(the_time);
        set_buttons();
    };
    var html5site = function (url) {
        // TODO
    };
    // Stop any customizations from previously loaded project
    stop_timer();
    $('#site').off('load');
    $('.custom_msg').fadeOut('slow', function () {
        $(this).remove();
    });
    $('#crossroads').remove();
	// Figure out what platform the project is running on then route to the appropriate function above
    if ('/' == _url.substr(_url.length - 1, 1)) _url = _url.substr(0, _url.length - 1);
    if (-1 != _url.toLowerCase().indexOf('crossroads.')) {
        _crossroads(_url);
    } else if (-1 != _url.toLowerCase().indexOf('.google.com/presentation')) {
        _googleslides(_url);
    } else {
        var url = _url + '/rdf/?format=json';
        $.ajax({
            url: url,
            jsonp: "callback",
            dataType: "jsonp",
            format: 'json',
            success: function (response) {
                _scalar(response, _url);
            },
            error: function (err) {
                _omeka(_url);
            }
        });
    };
};
// Set HTML into the nav bar's left and right slots
function set_buttons(first, last, first_callback, last_callback) {
    if ('undefined' == typeof(first)) first = '';
    if ('undefined' == typeof(last)) last = '';
    var $nav = $('#nav');
    $nav.find('.col:nth-of-type(2)').fadeOut(function() {
        $(this).html(first).fadeIn(function() {
            if ('function' == typeof(first_callback)) first_callback($nav.find('.col:nth-of-type(2)'));
        });
    });
    $nav.find('.col:nth-of-type(4)').fadeOut(function() {
        $(this).html(last).fadeIn(function () {
            if ('function' == typeof (last_callback)) last_callback($nav.find('.col:nth-of-type(4)'));
        });
    });
    $nav.find('.col:nth-of-type(1), .col:nth-of-type(5)').fadeOut(function() {
        $(this).fadeIn();
        $nav.find('button').blur();
    });
};
// Provide information about CommonPlace
function about_platform() {
    if ('undefined' != typeof(app_info.version_num)) $('.version_num').text("Version "+app_info.version_num);
    if ('undefined' != typeof(app_info.authors)) $('.app_authors').html(nl2br(app_info.authors.trim()));
    if ('undefined' != typeof(app_info.short_description)) $('.app_short_description').html(nl2br(app_info.short_description.trim()));
    if ('undefined' != typeof(app_info.long_description)) $('.app_long_description').html(nl2br(app_info.long_description.trim()));
    $('#aboutPlatformModal').modal({ backdrop: 'static' });
}
// Advanced options
function advanced_options() {
    $('#advancedOptionsModal').modal({ backdrop: 'static' });
    $('#advancedOptionsModal').find('.modal-body .show').collapse('hide');
    if (!$('#advancedOptionsModal').data('event_established')) {
        $('#advancedOptionsModal').data('event_established', true);
        // Close other panels when a new one is opened
        $('#advancedOptionsModal').find('.modal-body p > button').click(function() {
            $(this).closest('.modal-content').find('.show').collapse('hide');
        });
        // Restart CommonPlace
        $('#advancedOptionsModal').find('#restartMessage button').click(function () {
            $(this).closest('.modal').modal('toggle');
            var json = {};
            json.method = 'restart';
            window.external.notify(JSON.stringify(json));
        });
        // Toggle fullscreen
        $('#advancedOptionsModal').find('#toggleFullscreenButton').click(function() {
            var json = {};
            json.method = 'toggle_fullscreen';
            window.external.notify(JSON.stringify(json));
            var $this = $(this);
            $this.blur().text((-1 == $this.text().indexOf('Exit')) ? 'Exit fullscreen' : 'Enter fullscreen');
            $this.closest('.modal').modal('hide');
        });
        $('#advancedOptionsModal').find('#showEmailConfigButton').click(function() {
            var json = {};
            json.method = 'show_email_config';
            window.external.notify(JSON.stringify(json));
            $(this).closest('.modal').modal('hide');
        });
        // Start/stop auto-navigation
        $('#startStopAutoNavigate').click(function () {
            var $this = $(this);
            var is_stopped = ($this.data('stopped')) ? true : false;
            $this.data('stopped', ((is_stopped)?false:true));
            if (!is_stopped) {
                $this.text('Start all auto-navigation').removeClass('btn-default').addClass('btn-success');
                kill_child_timer(true);
            } else {
                $this.text('Stop all auto-navigation').removeClass('btn-success').addClass('btn-default');
                kill_child_timer(false);
            }
        });
    };
    // Write options in the choose path pulldown
    var $choosePathArea = $('#choosePath .card');
    $choosePathArea.empty();
    for (var j = 0; j < paths.length; j++) {
        if (j == path_index) continue;
        var $el = $('<a href="javascript:void(null);" data-path-index="' + j + '">' + paths[j].title + '</a>').appendTo($choosePathArea);
    };
    $choosePathArea.find('a').click(function () {
        var index = parseInt($(this).data('path-index'));
        if ('undefined' != typeof (index)) {
            $(this).addClass('active');
            setTimeout(function () {
                $.jStorage.set('commonplace_path_index', parseInt(index));
                $(this).closest('.modal').modal('toggle');
                var json = {};
                json.method = 'restart';
                window.external.notify(JSON.stringify(json));
            }, 700);
        }
    });
    $('#enterSourceForm').find('[name="enterSourceURL"]').val($.jStorage.get('commonplace_source', ''));
    $('#enterSourceForm').find('form').submit(function() {
        var url = $(this).find('[name="enterSourceURL"]').val();
        $.jStorage.set('commonplace_source', url);
        setTimeout(function () {
            var json = {};
            json.method = 'restart';
            window.external.notify(JSON.stringify(json));
            return false;
        }, 500);
    });
}
// Provide information about the current project
function about_project() {
    var url = paths[path_index].contents[project_index].url;
    var human_url = url.replace('/index', '').replace(/^https?:\/\//, '').replace(/\/$/, '');
    var $modal = $('#aboutProjectModal');
    var $body = $modal.find('.modal-body');
    $body.empty();
    var $row = $('<div class="container-fluid"><div class="row"><div class="col"></div><div class="col"></div></div></div>').appendTo($body);
    $('<img src="' + paths[path_index].contents[project_index].thumb + '" class="thumb rounded" /><br />').appendTo($row.find('.col:first'));
    $('<p><b>' + paths[path_index].contents[project_index].title + '</b><br /><small>' + human_url + '</small></p>').appendTo($row.find('.col:first'));
    if (paths[path_index].contents[project_index].description) $('<p class="content">' + paths[path_index].contents[project_index].description + '</p>').appendTo($row.find('.col:first'));
    if (paths[path_index].contents[project_index].authors) $('<p class="content">By ' + paths[path_index].contents[project_index].authors + '</p>').appendTo($row.find('.col:first'));
    var str = '<p class="content">';
    if (paths[path_index].contents[project_index].institution) str += paths[path_index].contents[project_index].institution + '<br />';
    if (paths[path_index].contents[project_index].publisher) str += 'Published by ' + paths[path_index].contents[project_index].publisher;
    if (paths[path_index].contents[project_index].publisher && paths[path_index].contents[project_index].date) str += ', ';
    if (paths[path_index].contents[project_index].date) str += paths[path_index].contents[project_index].date;
    str += '</p>';
    $row.find('.col:first').append(str);    
    if (paths[path_index].contents[project_index].content) $('<p class="content">' + paths[path_index].contents[project_index].content + '</p>').appendTo($row.find('.col:last'));
    $modal.modal({ backdrop: 'static' });
    $modal.off('hidden.bs.modal').on('hidden.bs.modal', function (event) {
        child_timer(true);
    });
    child_timer(false);
}
// Ask for an email address then send the current project to it
function send_email() {
    var title = paths[path_index].contents[project_index].title;
    var url = paths[path_index].contents[project_index].url;
    var $modal = $('#emailModal');
    $modal.find('p:first').html('Send me<br /><b>' + title + '</b>');
    $modal.modal({backdrop:'static'});
    $modal.find('input[type="email"]').val('').keyboard();
    $modal.find('.btn-primary:last').click(function(event) {
        event.stopPropagation();
        var address = $modal.find('input[type="email"]').val();
        if (!address.length || -1 == address.indexOf('@') || -1 == address.indexOf('.')) {
            $modal.find('input[type="email"]').focus();
            return;
        };
        $('#emailModal').modal('hide');
        child_timer(true);
        var json = {};
        json.method = 'email';
        json.address = address;
        json.title = title;
        json.url = url;
        window.external.notify(JSON.stringify(json));
    });
    $modal.off('hidden.bs.modal').on('hidden.bs.modal', function (event) {
        child_timer(true);
    });
    child_timer(false);
}
// Restart the timer
function reset_timer(start) {
	if ('undefined'!=typeof(interval)) {
		clearInterval(interval);
		interval = null;
	}
	if ('undefined'==typeof(start)) start = 10;
	interval = setInterval(function() {
        start--;
		if (!start) {
			clearInterval(interval);
			interval = null;
			animate_next_project();
			return;
		};
	}, 1000);
};
// Stop timer
function stop_timer() {
    if ('undefined' != typeof (interval)) {
        clearInterval(interval);
        interval = null;
    }    
}
// Start/stop auto-navigate timer
function child_timer(bool) {
    if ('undefined' == typeof (bool)) bool = false;
    if (bool && !global_stop_timer) {
        $('#site')[0].contentWindow.postMessage("autonavigate_reset_timer", '*');
    } else {
        $('#site')[0].contentWindow.postMessage("autonavigate_stop_timer", '*');
    };
    }
function kill_child_timer(bool) {
    if ('undefined' == typeof (bool)) bool = false;
    if (bool) {
        global_stop_timer = true;
        $('#site')[0].contentWindow.postMessage("autonavigate_kill_timer", '*');
    } else {
        global_stop_timer = false;
        $('#site')[0].contentWindow.postMessage("autonavigate_birth_timer", '*');
    };
}
// Set the project panel's content based on the current path
function set_panel() {
	$('#panel .row:not(:first)').remove();
	$pathTitle = $('#panel .path-title:first');
	$pathTitle.find('.title').html(paths[path_index].title);
	$pathTitle.find('.desc').html(paths[path_index].desc);
    var $row = null;
    var colspan = 6;
    // Write project icons
	for (var j = 0; j < paths[path_index].contents.length; j++) {
        if (j == 0 || j % colspan == 0) $row = $('<div class="row"></div>').appendTo('#panel > div:first');
		var $cell = $('<div class="col"></div>').appendTo($row);
		$cell.data('project_index', j);
        if (j == project_index) $cell.addClass('hl');
        $('<img src="' + paths[path_index].contents[j].thumb + '" class="rounded" /><br />').appendTo($cell);
        $('<h6>' + paths[path_index].contents[j].title + '</h6>').appendTo($cell);
        if (paths[path_index].contents[j].institution) $cell.append('<p class="institution">'+paths[path_index].contents[j].institution+'</p>');
        var authors = (paths[path_index].contents[j].authors) ? paths[path_index].contents[j].authors : 'No authors listed';
        $authors = $('<p class="authors">By ' + authors + '</p>').appendTo($cell);
        $('<div class="gradient"><div>').appendTo($cell);
    };
    if (j % colspan != 0) {
        for (var k = (j % colspan); k < colspan; k++) {
            $cell = $('<div class="col empty">&nbsp;</div>').appendTo($row);
        };
    };
    // Clicking a project icon chooses that project
    $('#panel').find('.col').each(function () {
        var $this = $(this);
        if ($this.closest('header').length) return;
        $this.on('click', function () {  // Click not mousedown so the list of projects can be scrolled
            var index = parseInt($(this).data('project_index'));
            project_index = index - 1;
            next_project();
            $('#panel').fadeOut('slow');
            $('#logo-wrapper button').removeClass('btn-secondary').addClass('btn-light');
        });
    });
    // Open and close the panel
    $('#logo-wrapper').off('mousedown').bind('mousedown', function() {
		var $panel = $('#panel');
        if ($panel.is(':visible')) {
            $('#logo-wrapper button').removeClass('btn-secondary').addClass('btn-light');
            $panel.fadeOut('slow');
            if (project_index > -1) {
                set_buttons(
                    '<button class="btn btn-light">About project</button>',
                    '<button class="btn btn-light">Email project</button>',
                    function (col) {
                        $(col).find('button').on('mousedown', function() {
                            about_project();
                        });
                    },
                    function (col) {
                        $(col).find('button').on('click', function() {
                            send_email();
                        });
                    }
                );
            } else {
                set_buttons('', '');
            }
            child_timer(true);
        } else {
            $('#logo-wrapper button').removeClass('btn-light').addClass('btn-secondary');
            $panel.fadeIn('slow');
            set_buttons(
                '<button class="btn btn-light">About CommonPlace</button>',
                '<button class="btn btn-light">Advanced options</button>',
                function (col) {
                    $(col).find('button').on('mousedown', about_platform);
                },
                function (col) {
                    $(col).find('button').on('mousedown', advanced_options);
                }
            );
            child_timer(false);
		};
    });
};
// Utils
function version_uri_to_content_uri(uri) {
	if (-1 == uri.indexOf('.')) return uri;
	uri = uri.substr(0, uri.lastIndexOf('.'));
	return uri;
};
function nl2br(str, is_xhtml) {  // http://kevin.vanzonneveld.net
  var breakTag = (is_xhtml || typeof is_xhtml === 'undefined') ? '<br ' + '/>' : '<br>';
  return (str + '').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1' + breakTag + '$2');
}
</script>
</head>
<body>
<iframe id="site" src=""></iframe>
<div id="panel">
    <div class="container-fluid">
        <header class="row">
            <div class="col path-title">
                <h2 class="title"></h2>
                <p class="desc"></p>
            </div>
        </header>
    </div>
</div>
<div id="nav" class="row">
    <div class="col"></div>
    <div class="col"></div>
    <div class="col text-center" id="logo-wrapper"><button type="button" class="btn btn-light">CommonPlace Menu</button></div>
    <div class="col"></div>
    <div class="col"></div>
</div>
<div class="modal fade" id="aboutPlatformModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
        <div class="modal-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col">
                        <img src="common/css/Square44x44Logo.scale-400.png" class="thumb rounded" /><br />
                        <p>
                            <b>CommonPlace Screen</b>
                            <small class="app_authors"></small>
                            <small class="version_num"></small>
                        </p>
                        <p class="content">
                            <span class="app_short_description"></span>
                        </p>
                    </div>
                    <div class="col">
                        <p class="content">
                            <span class="app_long_description"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="advancedOptionsModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title">Advanced options</h5>
          </div>
          <div class="modal-body">
              <!-- restart -->
              <h6>Actions</h6>
              <p>
                  <button class="btn btn-default" type="button" data-toggle="collapse" data-target="#choosePath" aria-expanded="false" aria-controls="choosePath">Switch to a different collection</button>
                  &nbsp; &nbsp;
                  <button class="btn btn-default" type="button" data-toggle="collapse" data-target="#restartMessage" aria-expanded="false" aria-controls="restartMessage">Restart CommonPlace</button>
                  &nbsp; &nbsp;
                  <button class="btn btn-default" type="button" id="toggleFullscreenButton">Exit fullscreen</button>
              </p>
              <h6>Configuration</h6>
              <p>
                  <button class="btn btn-default" type="button" id="showEmailConfigButton">Set email SMTP fields</button>
                  &nbsp; &nbsp;
                  <button class="btn btn-default" type="button" data-toggle="collapse" data-target="#enterSourceForm">Change projects source</button>
                  &nbsp; &nbsp;
                  <button class="btn btn-default" type="button" id="startStopAutoNavigate">Stop all auto-navigation</button>
              </p>
              <div class="collapse" id="restartMessage">
                  <div class="card card-body">
                      Restarting CommonPlace will reload the app with any new content that might exist in connected data sources. CommonPlace will then begin, as typical, with the first project in the default collection.<br />
                      <button class="btn btn-primary">Restart</button>
                  </div>
              </div>
              <div class="collapse" id="choosePath">
                  <div class="card card-body"></div>
              </div>
              <div class="collapse" id="enterSourceForm">
                  <div class="card card-body">
                      Enter the URL to a Scalar book or Google Spreadsheet formatted to be a projects source for CommonPlace. To remove later, delete the URL and save.<br />
                      <form class="form-inline" style="margin-top:20px;">
                          <input type="text" name="enterSourceURL" class="form-control col-10" style="margin-bottom:12px;" />
                          <button class="btn btn-primary" style="margin-bottom:12px;">Save and load</button>
                      </form>
                  </div>
              </div>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
      </div>
  </div>
</div>
<div class="modal fade" id="aboutProjectModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="emailModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <p></p>
        <form>
            <div class="form-group">
                <input type="email" class="keyboard form-control" placeholder="me@example.com">
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary">Send email</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>