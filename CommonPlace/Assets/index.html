<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>CommonPlace</title>
<meta name="author" content="http://craigdietrich.com">
<link rel="stylesheet" href="common/css/bootstrap.min.css">
<link rel="stylesheet" href="common/css/jqbtk.css">
<link rel="stylesheet" href="common/css/main.css">
<script src="common/js/jquery-3.2.1.min.js"></script>
<script src="common/js/popper.min.js"></script>
<script src="common/js/bootstrap.min.js"></script>
<script src="common/js/jstorage.min.js"></script>
<script src="common/js/jqbtk.js"></script>
<script>
var primary = 'http://scalar.cdla.oxycreates.org/commonplace/';
var paths = [];
var path_index = 0;
var project_index = -1;
var desc_max_length = 500;
// Get paths and projects
$(document).ready(function() {
    $('#site').attr('src', primary + 'index');
	get_paths(primary, function(_paths) {
		paths = _paths.slice();
        $('#nav, #arrow-up').fadeTo('slow', 1);
        set_panel();
        reset_timer(10);  // Timer for the splash page
    });
    window.addEventListener("message", function (event) {
        if ('autonavigate_finished' == event.data) next_project();
    }, false);
    if (typeof (Storage) === "undefined") set_messages('localStorage not supported');
    // localStorage.setItem("test_storage", "Craig");
});
// Go get the paths from a Scalar book and build an array of paths and projects
function get_paths(url, callback) {
	var paths = [];
	var parsed = [];
	$.ajax({
	    url: url+'rdf/instancesof/path?rec=1&format=json&t='+(new Date().getTime()),
	    jsonp: "callback",
	    dataType: "jsonp",
	    format:'json',
	    success: function(response) {
	    	var _ordinal = 1;
			for (var uri in response) {
				var path = {};
				if ('http://www.openannotation.org/ns/Annotation' != response[uri]['http://www.w3.org/1999/02/22-rdf-syntax-ns#type'][0].value) continue;
				path.version_uri = response[uri]['http://www.openannotation.org/ns/hasBody'][0].value;
				path.content_uri = version_uri_to_content_uri(path.version_uri);
				if ('undefined' != typeof(parsed[path.content_uri])) continue;
				parsed.push(path.content_uri);
				path.title = response[path.version_uri]['http://purl.org/dc/terms/title'][0].value;
				path.desc = ('undefined'!=typeof(response[path.version_uri]['http://purl.org/dc/terms/description'])) ? response[path.version_uri]['http://purl.org/dc/terms/description'][0].value : null;
				path.ordinal = ('undefined'!=typeof(response[path.version_uri]['http://id3.org/id3v2.4.0#Track'])) ? parseInt(response[path.version_uri]['http://id3.org/id3v2.4.0#Track'][0].value) : 0;
				if (!path.ordinal) {
					path.ordinal = _ordinal;
					_ordinal++;
				} else {
					_ordinal = path.ordinal + 1;
				};
				path.contents = [];
				for (var key in response) {
					if ('http://www.openannotation.org/ns/Annotation' != response[key]['http://www.w3.org/1999/02/22-rdf-syntax-ns#type'][0].value) continue;
					if (path.version_uri != response[key]['http://www.openannotation.org/ns/hasBody'][0].value) continue;
					var content = {};
					content.target = response[key]['http://www.openannotation.org/ns/hasTarget'][0].value;
					content.version_uri = content.target.substr(0, content.target.lastIndexOf('#'));
					content.content_uri = version_uri_to_content_uri(content.version_uri);
					content.index = parseInt(content.target.substr(content.target.indexOf('index=')+6));
                    content.title = response[content.version_uri]['http://purl.org/dc/terms/title'][0].value;
                    content.description = ('undefined' != typeof (response[content.version_uri]['http://purl.org/dc/terms/description'])) ? response[content.version_uri]['http://purl.org/dc/terms/description'][0].value : null;
                    content.content = ('undefined' != typeof (response[content.version_uri]['http://rdfs.org/sioc/ns#content'])) ? response[content.version_uri]['http://rdfs.org/sioc/ns#content'][0].value : null;
                    content.thumb = ('undefined' != typeof (response[content.content_uri]['http://simile.mit.edu/2003/10/ontologies/artstor#thumbnail'])) ? response[content.content_uri]['http://simile.mit.edu/2003/10/ontologies/artstor#thumbnail'][0].value : null;
                    if (!content.thumb) content.thumb = 'http://scalar.cdla.oxycreates.org/system/application/views/modules/oxy_book_list/common/images/default_book_logo.png'; 
                    content.url = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/url'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/url'][0].value : null;
                    content.short_url = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/shortUrl'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/shortUrl'][0].value : '(no url)';
                    content.authors = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/authors'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/authors'][0].value : null;
                    content.institution = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/institution'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/institution'][0].value : null;
                    content.publisher = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/publisher'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/publisher'][0].value : null;
                    content.date = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/date'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/date'][0].value : null;
                    path.contents.push(content);
				};
				paths[(path.ordinal-1)] = path;
			};
			callback(paths);
	    },
	    error: function(err) {
	    	console.log(err);
	    	callback(paths);
	    }
	});	
};
// Go to the next project on the path
function prev_project() {
	project_index--;
	if ('undefined'==typeof(paths[path_index].contents[project_index])) project_index = 0;
	console.log('Going to project: '+paths[path_index].contents[project_index].url);
	go_to_site(paths[path_index].contents[project_index].url);
	set_panel();
};
// Go to the previous project on the path
function next_project() {
	project_index++;
	if ('undefined'==typeof(paths[path_index].contents[project_index])) project_index = 0;  // Start over
	console.log('Going to project: '+paths[path_index].contents[project_index].url);
	go_to_site(paths[path_index].contents[project_index].url);
	set_panel();
};
// Determine the platform and load the project then reset the timer
function go_to_site(_url) {
	var _scalar = function(response, url) {
		console.log('Scalar: '+url);
        for (var uri in response) break;
        if ('undefined'==typeof(response[uri]['http://purl.org/dc/terms/isPartOf'])) {
        	alert('Scalar: could not find dcterms:isPartOf field for '+url);
        	return;
        }
        var system = response[uri]['http://purl.org/dc/terms/isPartOf'][0].value;
        var plugin = system + 'system/application/plugins/auto-navigate/index.html?book='+url.replace(system,'')+'&t='+(new Date().getTime());
        $('#site').unbind('load').on("load", function() {
			// Nothing to do
        }).fadeIn('slow').attr('src', plugin);
        set_messages(
            '<a href="javascript:void(null);" class="btn-dotted">About this project</a> &nbsp; &nbsp; <a href="javascript:void(null);" class="btn-dotted">Email this project</a>',
            '<a href="javascript:void(null);" class="btn-dotted blank">About this project</a> &nbsp; &nbsp; <a href="javascript:void(null);" class="btn-dotted blank">Email this project</a>',
            function (col) {
                $(col).find('a:first').click(function () {
                    about_project();
                });
                $(col).find('a:last').click(function () {
                    send_email();
                });
            },
            null
        );

	};
	var _omeka = function(url) {
		console.log('Omeka: '+url);
		var plugin = url + '/plugins/AutoNavigate/index.html?t='+(new Date().getTime());
        $('#site').unbind('load').on("load", function() {
			// Nothing to do
        }).fadeIn('slow').attr('src', plugin);
        //set_messages('', '');
	};
	var _crossroads = function(url) {
        console.log('Crossroads: ' + url);
        //set_messages('', '');
	};
	if ('/'==_url.substr(_url.length-1, 1)) _url = _url.substr(0, _url.length-1);
	// Figure out whether the URL is to a Scalar, Omeka, or Crossroads project then route to the appropriate function
	if (-1 != _url.indexOf('crossroads.')) _crossroads(_url);
	var url = _url + '/rdf/?format=json';
	$.ajax({
	    url: url,
	    jsonp: "callback",
	    dataType: "jsonp",
	    format:'json',
	    success: function(response) {
			_scalar(response, _url);
	    },
	    error: function(err) {  // TODO: check this with https sites
	    	_omeka(_url);
	    }
	});
};
// Set HTML into the left/right of the nav bar
function set_messages(first, last, first_callback, last_callback) {
    if ('undefined' == typeof(first)) first = '';
    if ('undefined' == typeof (last)) last = '';
    $('#nav').find('.col:first').fadeOut(function () {
        var $this = $(this);
        $this.removeClass('has-btn');
        if (first.indexOf('btn-dotted') != -1) $this.addClass('has-btn');
        $this.html(first).fadeIn(function () {
            if ('function' == typeof (first_callback)) first_callback(this);
        });
    });
    $('#nav').find('.col:last').fadeOut(function () {
        var $this = $(this);
        $this.removeClass('has-btn');
        if (last.indexOf('btn-dotted') != -1) $this.addClass('has-btn');
        $(this).html(last).fadeIn(function () {
            if ('function' == typeof (last_callback)) last_callback(this);
        });
    });
};
// Return what is present in the left/right of the nav bar
function get_messages() {
    var first = $('#nav').find('.col:first').html();
    var last = $('#nav').find('.col:last').html();
    return [first, last];
}
// Provide information about CommonPlace
function about_platform() {
    $('#aboutPlatformModal').modal({backdrop:'static'});
}
// Provide information about the current project
function about_project() {
    var url = paths[path_index].contents[project_index].url;
    var human_url = url.replace('/index', '').replace(/^https?:\/\//, '').replace(/\/$/, '');
    var $modal = $('#aboutProjectModal');
    var $body = $modal.find('.modal-body');
    $body.empty();
    var $row = $('<div class="container-fluid"><div class="row"><div class="col"></div><div class="col"></div></div></div>').appendTo($body);
    $('<img src="' + paths[path_index].contents[project_index].thumb + '" class="thumb rounded" /><br />').appendTo($row.find('.col:first'));
    $('<p><b>' + paths[path_index].contents[project_index].title + '</b><br /><small>' + human_url + '</small></p>').appendTo($row.find('.col:first'));
    if (paths[path_index].contents[project_index].description) $('<p class="content">' + paths[path_index].contents[project_index].description + '</p>').appendTo($row.find('.col:first'));
    if (paths[path_index].contents[project_index].authors) $('<p class="content">By ' + paths[path_index].contents[project_index].authors + '</p>').appendTo($row.find('.col:first'));
    var str = '<p class="content">';
    if (paths[path_index].contents[project_index].institution) str += paths[path_index].contents[project_index].institution + '<br />';
    if (paths[path_index].contents[project_index].publisher) str += 'Published by ' + paths[path_index].contents[project_index].publisher;
    if (paths[path_index].contents[project_index].publisher && paths[path_index].contents[project_index].date) str += ', ';
    if (paths[path_index].contents[project_index].date) str += paths[path_index].contents[project_index].date;
    str += '</p>';
    $row.find('.col:first').append(str);    
    if (paths[path_index].contents[project_index].content) $('<p class="content">' + paths[path_index].contents[project_index].content + '</p>').appendTo($row.find('.col:last'));
    $modal.modal({backdrop:'static'});    
}
// Ask for an email address then send the current project to it
function send_email() {
    var title = paths[path_index].contents[project_index].title;
    var url = paths[path_index].contents[project_index].url;
    var $modal = $('#emailModal');
    $modal.find('p:first').html('Send me<br /><b>' + title + '</b>');
    $modal.modal({backdrop:'static'});
    $modal.find('input[type="email"]').keyboard();
    $modal.find('.btn-primary:last').click(function (event) {
        event.stopPropagation();
        var address = $modal.find('input[type="email"]').val();
        if (!address.length || -1 == address.indexOf('@') || -1 == address.indexOf('.')) {
            $modal.find('input[type="email"]').focus();
            return;
        };
        $('#emailModal').modal('hide');
        var json = {};
        json.method = 'email';
        json.address = address;
        json.title = title;
        json.url = url;
        window.external.notify(JSON.stringify(json));
    });
    //$modal.find('input[type="email"]').focus();
}
// Restart the timer
function reset_timer(start) {
	if ('undefined'!=typeof(interval)) {
		clearInterval(interval);
		interval = null;
	}
	if ('undefined'==typeof(start)) start = 10;
	interval = setInterval(function() {
		start--;
		if (!start) {
			clearInterval(interval);
			interval = null;
			next_project();
			return;
		};
	}, 1000);
};
// Set the popup panel's content based on the current project
function set_panel() {
	$('#panel .row:not(:first)').remove();
	$pathTitle = $('#panel .path-title:first');
	$pathTitle.find('.title').text(paths[path_index].title);
	$pathTitle.find('.desc').text(paths[path_index].desc);
    var $row = null;
    var colspan = 6;
    console.log(paths[path_index]);
	for (var j = 0; j < paths[path_index].contents.length; j++) {
        if (j == 0 || j % colspan == 0) $row = $('<div class="row"></div>').appendTo('#panel > div:first');
		var $cell = $('<div class="col"></div>').appendTo($row);
		$cell.data('project_index', j);
        if (j == project_index) $cell.addClass('hl');
        $('<img src="' + paths[path_index].contents[j].thumb + '" class="rounded" /><br />').appendTo($cell);
        $('<h6>' + paths[path_index].contents[j].title + '</h6>').appendTo($cell);
        if (paths[path_index].contents[j].institution) $cell.append('<p class="institution">'+paths[path_index].contents[j].institution+'</p>');
        var authors = (paths[path_index].contents[j].authors) ? paths[path_index].contents[j].authors : 'No authors listed';
        $authors = $('<p class="authors">By ' + authors + '</p>').appendTo($cell);
        $('<div class="gradient"><div>').appendTo($cell);
    };
    if (j % colspan != 0) {
        for (var k = (j % colspan); k < colspan; k++) {
            $cell = $('<div class="col">&nbsp;</div>').appendTo($row);
        };
    };
	$('#panel').find('.col').bind('mousedown', function() {
		var index = parseInt($(this).data('project_index'));
		project_index = index - 1;
		next_project();
        $('#panel').fadeOut('slow');
        $('#arrow-up').removeClass('down');
	});
    $('#logo-wrapper, #arrow-up').off('mousedown').bind('mousedown', function() {
		var $panel = $('#panel');
		if ($panel.is(':visible')) {
            $panel.fadeOut('slow');
            $('#arrow-up').removeClass('down');
            if (project_index > -1) {
                set_messages(
                    '<a href="javascript:void(null);" class="btn-dotted">About this project</a> &nbsp; &nbsp; <a href="javascript:void(null);" class="btn-dotted">Email this project</a>',
                    '<a href="javascript:void(null);" class="btn-dotted blank">About this project</a> &nbsp; &nbsp; <a href="javascript:void(null);" class="btn-dotted blank">Email this project</a>',
                    function (col) {
                        $(col).find('a:first').click(function () {
                            about_project();
                        });
                        $(col).find('a:last').click(function () {
                            send_email();
                        });
                    },
                    null
                );
            } else {
                set_messages('', '');
            }
		} else {
            $panel.fadeIn('slow');
            $('#arrow-up').addClass('down');
            set_messages(
                '<a href="javascript:void(null);" class="btn-dotted">About CommonPlace</a>',
                '<a href="javascript:void(null);" class="btn-dotted">Advanced features</a>',
                function (col) {
                    $(col).find('a:first').click(function () {
                        about_platform();
                    });
                },
                null
            );
		};
    });
};
// Utils
function version_uri_to_content_uri(uri) {
	if (-1 == uri.indexOf('.')) return uri;
	uri = uri.substr(0, uri.lastIndexOf('.'));
	return uri;
};
</script>
</head>
<body>
<iframe id="site" src=""></iframe>
<div id="panel">
	<div class="container-fluid">
	 	<div class="row">
    		<div class="col path-title">
     		 	<h2 class="title"></h2>
     		 	<p class="desc"></p>
    		</div>
		</div>
	</div>
</div>
<div id="arrow-up"></div>
<div id="nav" class="row">
    <div class="col"></div>
    <div class="col text-center" id="logo-wrapper"></div>
    <div class="col"></div>
</div>
<div class="modal fade" id="aboutPlatformModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
        <div class="modal-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col">
                        <img src="Square44x44Logo.scale-400.png" class="thumb rounded" /><br />
                        <p><b>CommonPlace</b></p>
                        <p class="content">
                            Maecenas sagittis turpis vitae felis accumsan condimentum. Aliquam erat volutpat. Etiam placerat mollis felis, sit amet accumsan nisi placerat vitae. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas vestibulum quam risus, ut tempus ipsum fringilla id.
                        </p>
                    </div>
                    <div class="col">
                        <p class="content">
                            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi sodales id leo in commodo. Morbi rhoncus odio ut ligula auctor vestibulum. Maecenas pulvinar sem eu nibh suscipit lacinia. Sed aliquam felis in felis tristique placerat. Quisque molestie ornare risus in varius. Phasellus auctor sagittis tempus. Proin ut dui eu nulla molestie bibendum. Morbi nec porttitor magna, maximus facilisis velit.
                        </p>
                        <p class="content">
                            Suspendisse et blandit quam, non pulvinar tortor. Proin tincidunt semper ultricies. Aliquam congue arcu ipsum, pulvinar egestas nibh hendrerit sed. Etiam eu dolor at enim rutrum pharetra id volutpat quam. Aliquam libero metus, finibus id orci eu, mollis accumsan magna.
                        </p>
                        <p class="content">
                            Donec aliquam augue neque, eu mollis dui commodo vel. Donec consequat vulputate lobortis. Morbi ac cursus tortor. Nam venenatis ante in nunc dignissim finibus. Duis consectetur eleifend dui, non lobortis nibh sagittis a. Cras et erat sapien. Sed finibus, nibh at rhoncus pulvinar, turpis dolor vestibulum elit, ut feugiat velit erat eget augue.
                        </p>
                    </div>
                </div>
            </div>
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="aboutProjectModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="emailModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <p></p>
        <form>
            <div class="form-group">
                <input type="email" class="keyboard form-control" placeholder="me@example.com">
                <!--
                <br />
                <small class="form-text text-muted">
                    We'll send you the URL to the project you're currently reading.<br />
                    Your email address doesn't get saved and will never be shared.
                </small>
                -->
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary">Send email</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>