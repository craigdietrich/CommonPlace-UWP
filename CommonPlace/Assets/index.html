<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>CommonPlace</title>
<meta name="author" content="http://craigdietrich.com">
<link rel="stylesheet" href="common/css/bootstrap.min.css">
<link rel="stylesheet" href="common/css/jqbtk.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Exo">
<link rel="stylesheet" href="common/css/crossroads.css">
<link rel="stylesheet" href="common/css/main.css">
<script src="common/js/jquery-3.2.1.min.js"></script>
<script src="common/js/popper.min.js"></script>
<script src="common/js/bootstrap.min.js"></script>
<script src="common/js/jstorage.min.js"></script>
<script src="common/js/jqbtk.js"></script>
<script src="common/js/jquery.textfill.min.js"></script>
<script src="common/js/jquery.crossroads.js"></script>
<script>
var app_info = {};
var primary = 'http://scalar.cdla.oxycreates.org/commonplace/';
var paths = [];
var path_index = 1;
var project_index = -1;
$(document).ready(function() {
    // Get projects and start the rotation
    get_paths(primary, function (_paths) {
        paths = _paths.slice();  // TODO
        console.log(paths);
        path_index = get_path_index();
        console.log('path_index: ' + path_index);
        set_panel();
        $('#nav').fadeTo('slow', 1, function () {
            animate_next_project();
        });
    });
    // Messages from the auto-navigate plugin
    window.addEventListener("message", function (event) {
        switch (event.data) {
            case 'autonavigate_finished':
                animate_next_project();
                break;
            case 'autonavigate_click':
                $('#nav').find('.col:first, .col:last').tooltip('hide');
                break;
            case 'autonavigate_user_interaction':
                $('#nav').find('.col:first, .col:last').tooltip('hide');
                break;
        }
    }, false);
});
// Get info from the app itself
function set_app_vars(version_num, authors, short_description, long_description) {
    app_info.version_num = version_num;
    app_info.authors = authors;
    app_info.short_description = short_description;
    app_info.long_description = long_description;
};
// Sort paths by title
function path_compare(a,b) {
    if (a.title < b.title)
        return -1;
    if (a.title > b.title)
        return 1;
    return 0;
}
// Go get the paths from a Scalar book and build an array of paths and projects
function get_paths(url, callback) {
	var paths = [];
	var parsed = [];
	$.ajax({
	    url: url+'rdf/instancesof/path?rec=1&format=json&t='+(new Date().getTime()),
	    jsonp: "callback",
	    dataType: "jsonp",
	    format:'json',
	    success: function(response) {
            for (var uri in response) {
				var path = {};
				if ('http://www.openannotation.org/ns/Annotation' != response[uri]['http://www.w3.org/1999/02/22-rdf-syntax-ns#type'][0].value) continue;
				path.version_uri = response[uri]['http://www.openannotation.org/ns/hasBody'][0].value;
                path.content_uri = version_uri_to_content_uri(path.version_uri);
                if (-1 != parsed.indexOf(path.content_uri)) continue;
                parsed.push(path.content_uri);
				path.title = response[path.version_uri]['http://purl.org/dc/terms/title'][0].value;
				path.desc = ('undefined'!=typeof(response[path.version_uri]['http://purl.org/dc/terms/description'])) ? response[path.version_uri]['http://purl.org/dc/terms/description'][0].value : null;
				path.contents = [];
				for (var key in response) {
					if ('http://www.openannotation.org/ns/Annotation' != response[key]['http://www.w3.org/1999/02/22-rdf-syntax-ns#type'][0].value) continue;
					if (path.version_uri != response[key]['http://www.openannotation.org/ns/hasBody'][0].value) continue;
					var content = {};
					content.target = response[key]['http://www.openannotation.org/ns/hasTarget'][0].value;
					content.version_uri = content.target.substr(0, content.target.lastIndexOf('#'));
					content.content_uri = version_uri_to_content_uri(content.version_uri);
					content.index = parseInt(content.target.substr(content.target.indexOf('index=')+6));
                    content.title = response[content.version_uri]['http://purl.org/dc/terms/title'][0].value;
                    content.description = ('undefined' != typeof (response[content.version_uri]['http://purl.org/dc/terms/description'])) ? response[content.version_uri]['http://purl.org/dc/terms/description'][0].value : null;
                    content.content = ('undefined' != typeof (response[content.version_uri]['http://rdfs.org/sioc/ns#content'])) ? response[content.version_uri]['http://rdfs.org/sioc/ns#content'][0].value : null;
                    content.thumb = ('undefined' != typeof (response[content.content_uri]['http://simile.mit.edu/2003/10/ontologies/artstor#thumbnail'])) ? response[content.content_uri]['http://simile.mit.edu/2003/10/ontologies/artstor#thumbnail'][0].value : null;
                    if (!content.thumb) content.thumb = 'http://scalar.cdla.oxycreates.org/system/application/views/modules/oxy_book_list/common/images/default_book_logo.png'; 
                    content.url = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/url'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/url'][0].value : null;
                    content.short_url = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/shortUrl'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/shortUrl'][0].value : '(no url)';
                    content.authors = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/authors'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/authors'][0].value : null;
                    content.institution = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/institution'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/institution'][0].value : null;
                    content.publisher = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/publisher'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/publisher'][0].value : null;
                    content.date = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/date'])) ? response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/date'][0].value : null;
                    content.slideDeckNumSlides = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/slideDeckNumSlides'])) ? parseInt(response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/slideDeckNumSlides'][0].value) : 0;
                    content.slideDeckSecondsPerSlide = ('undefined' != typeof (response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/slideDeckSecondsPerSlide'])) ? parseInt(response[content.version_uri]['http://scalar.cdla.oxycreates.org/commonplace/terms/slideDeckSecondsPerSlide'][0].value) : 0;
                    path.contents.push(content);
				};
                paths.push(path);
            };
            paths.sort(path_compare);
			callback(paths);
	    },
	    error: function(err) {
	    	console.log(err);
	    	callback(paths);
	    }
	});	
};
// Get the path index either from localStorage or default to the first path
function get_path_index() {
    var index = $.jStorage.get('commonplace_path_index', 0);
    return index;
}
// Go to the next project on the path
function prev_project() {
	project_index--;
	if ('undefined'==typeof(paths[path_index].contents[project_index])) project_index = 0;
	go_to_site(paths[path_index].contents[project_index].url);
	set_panel();
};
// Go to the previous project on the path
function next_project() {
	project_index++;
	if ('undefined'==typeof(paths[path_index].contents[project_index])) project_index = 0;
	go_to_site(paths[path_index].contents[project_index].url);
	set_panel();
};
// Go to the next project but first visit the panel and select the next project
function animate_next_project(step) {
    if ('undefined' == typeof(step)) step = 1;
    switch (step) {
        case 1:
            if ($('#panel').is(':visible') || $('.modal.show').length) return;
            $('#logo-wrapper').mousedown();
            setTimeout(function () {
                animate_next_project(2);
            }, 9000);
            break;
        case 2:
            if (!$('#panel').is(':visible') || $('.modal.show').length) return;
            if ($('#panel').find('.col.hl').length) {
                var index = 0;
                var total = 0;
                $('#panel').find('.col:not(.empty):not(.path-title)').each(function (_index) {
                    if ($(this).hasClass('hl')) index = _index;
                    total++;
                });
                console.log('index ' + index + ' total ' + total);
                var $this = $('#panel').find('.col:not(.empty):not(.path-title)').eq(index);
                $this.removeClass('hl');
                if (index < total - 1) {
                    $('#panel').find('.col:not(.empty):not(.path-title)').eq(index + 1).addClass('hl');
                } else {
                    $('#panel').find('.row:not(:first)').eq(0).find('.col').eq(0).addClass('hl');
                };
            } else {
                $('#panel').find('.row:not(:first)').eq(0).find('.col').eq(0).addClass('hl');
            };
            var $el = $('#panel').find('.col.hl').eq(0);
            var scrollHeight = parseInt($('#panel')[0].scrollHeight);
            var totalScroll = scrollHeight - parseInt($('#panel').height());
            var vertBuffer = parseInt($('#nav').height()) * 2;
            var relativePosition = parseInt($el.position().top) + parseInt($el.height()) + vertBuffer + parseInt($('#panel')[0].scrollTop);
            var scrollTop = 0;
            if (relativePosition > parseInt($('#panel').height())) {
                scrollTop = relativePosition - parseInt($('#panel').height());
                if (scrollTop > totalScroll) scrollTop = totalScroll;
            }
            console.log('relativePosition: ' + relativePosition + ' panel height: ' + $('#panel').height()+' scrollTop: ' + scrollTop + ' totalScroll ' + totalScroll);
            $('#panel').animate({
                scrollTop: scrollTop
            }, 2000, function () {
                setTimeout(function () {
                    animate_next_project(3);
                }, 2000);
            });
            break;
        case 3:
            if (!$('#panel').is(':visible') || $('.modal.show').length) return;
            $('#panel').find('.col.hl').click();
            break;
    };
};
// Determine the platform and load the project
function go_to_site(_url) {
    var _scalar = function (response, url) {
        for (var uri in response) break;
        if ('undefined'==typeof(response[uri]['http://purl.org/dc/terms/isPartOf'])) {
        	alert('Scalar: could not find dcterms:isPartOf field for '+url);
        	return;
        }
        var system = response[uri]['http://purl.org/dc/terms/isPartOf'][0].value;
        var plugin = system + 'system/application/plugins/auto-navigate/index.html?book='+url.replace(system,'')+'&t='+(new Date().getTime());
        $('#site').fadeIn('slow').attr('src', plugin);
        set_messages(
            '<a href="javascript:void(null);" class="btn-dotted">About this project</a>',
            '<a href="javascript:void(null);" class="btn-dotted">Email this project</a>',
            function (col) {
                $(col).find('a:first').click(function () {
                    about_project();
                });
            },
            function (col) {
                $(col).find('a:last').click(function () {
                    send_email();
                });
            }
        );
	};
	var _omeka = function(url) {
		var plugin = url + '/plugins/AutoNavigate/index.html?t='+(new Date().getTime());
        $('#site').fadeIn('slow').attr('src', plugin);
        set_messages(
            '<a href="javascript:void(null);" class="btn-dotted">About this project</a>',
            '<a href="javascript:void(null);" class="btn-dotted">Email this project</a>',
            function (col) {
                $(col).find('a:first').click(function () {
                    about_project();
                });
            },
            function (col) {
                $(col).find('a:last').click(function () {
                    send_email();
                });
            }
        );
	};
    var _crossroads = function (url) {
        $('#site').attr('src', '');
        if ('undefined' == typeof (crossroads_projects)) crossroads_projects = null;  // Global
        if (null == crossroads_projects) {
            $.fn.crossroads('get_projects', function (project_list) {
                crossroads_projects = project_list.slice();
                console.log('Attained projects');
                _crossroads(url);
            });
            return;
        };
        $('<div id="crossroads" data-url="'+url+'"></div>').insertAfter('#site');
        var $crossroads = $('#crossroads');
        $crossroads.crossroads({
            title: paths[path_index].contents[project_index].title,
            authors: paths[path_index].contents[project_index].authors,
            url: _url,
            projects: crossroads_projects,
            item_index: 0
        });
        set_messages(
            '<a href="javascript:void(null);" class="btn-dotted">About this project</a>',
            '<a href="javascript:void(null);" class="btn-dotted">Email this project</a>',
            function (col) {
                $(col).find('a:first').click(function () {
                    about_project();
                });
            },
            function (col) {
                $(col).find('a:last').click(function () {
                    send_email();
                });
            }
        );
    };
    var _googleslides = function (url) {
        var $site = $('#site');
        $site.fadeIn('slow').off('load').on('load', function () {
            var $custom = $('<div class="custom_msg"></div>').insertAfter($site).hide();
            $custom.html('<b>' + paths[path_index].contents[project_index].title + '</b> by ' + paths[path_index].contents[project_index].authors);
            $custom.fadeIn('slow');
        }).attr('src', url);
        var the_time = (paths[path_index].contents[project_index].slideDeckNumSlides + 1) * paths[path_index].contents[project_index].slideDeckSecondsPerSlide;
        the_time = the_time + Math.round((paths[path_index].contents[project_index].slideDeckNumSlides + 1) * 0.4);
        reset_timer(the_time);
        set_messages();
    };
    var html5site = function (url) {
        // TODO
    };
    // Stop any customizations from previously loaded project
    stop_timer();
    $('#site').off('load');
    $('.custom_msg').fadeOut('slow', function () {
        $(this).remove();
    });
    $('#crossroads').crossroads('destroy').remove();
	// Figure out what platform the project is running on then route to the appropriate function above
    if ('/' == _url.substr(_url.length - 1, 1)) _url = _url.substr(0, _url.length - 1);
    if (-1 != _url.toLowerCase().indexOf('crossroads.')) {
        _crossroads(_url);
    } else if (-1 != _url.toLowerCase().indexOf('.google.com/presentation')) {
        _googleslides(_url);
    } else {
        var url = _url + '/rdf/?format=json';
        $.ajax({
            url: url,
            jsonp: "callback",
            dataType: "jsonp",
            format: 'json',
            success: function (response) {
                _scalar(response, _url);
            },
            error: function (err) {
                _omeka(_url);
            }
        });
    };
};
// Set HTML into the nav bar's left and right slots
function set_messages(first, last, first_callback, last_callback) {
    if ('undefined' == typeof(first)) first = '';
    if ('undefined' == typeof (last)) last = '';
    var $nav = $('#nav');
    $nav.find('.col:nth-of-type(2)').fadeOut(function() {
        var $this = $(this);
        $this.removeClass('has-btn');
        if (first.indexOf('btn-dotted') != -1) $this.addClass('has-btn');
        $this.html(first).fadeIn(function () {
            if ('function' == typeof (first_callback)) first_callback(this);
        });
    });
    $nav.find('.col:nth-of-type(4)').fadeOut(function () {
        var $this = $(this);
        $this.removeClass('has-btn');
        if (last.indexOf('btn-dotted') != -1) $this.addClass('has-btn');
        $(this).html(last).fadeIn(function () {
            if ('function' == typeof (last_callback)) last_callback(this);
        });
    });
    $nav.find('.col:first, .col:last').tooltip({ trigger: 'click' }).animate({ opacity: 0 })
    if (first.length || last.length) $nav.find('.col:first, .col:last').animate({ opacity: 1 });
};
// Provide information about CommonPlace
function about_platform() {
    if ('undefined' != typeof(app_info.version_num)) $('.version_num').text("Version "+app_info.version_num);
    if ('undefined' != typeof(app_info.authors)) $('.app_authors').html(nl2br(app_info.authors.trim()));
    if ('undefined' != typeof(app_info.short_description)) $('.app_short_description').html(nl2br(app_info.short_description.trim()));
    if ('undefined' != typeof(app_info.long_description)) $('.app_long_description').html(nl2br(app_info.long_description.trim()));
    $('#aboutPlatformModal').modal({ backdrop: 'static' });
}
// Advanced features in the panel
function advanced_options() {
    $('#advancedOptionsModal').modal({ backdrop: 'static' });
    $('#advancedOptionsModal').find('.modal-body .show').collapse('hide');
    if (!$('#advancedOptionsModal').data('event_established')) {
        $('#advancedOptionsModal').data('event_established', true);
        // Close other panels when a new one is opened
        $('#advancedOptionsModal').find('.modal-body p > button').click(function() {
            $(this).closest('.modal-content').find('.show').collapse('hide');
        });
        // Restart CommonPlace
        $('#advancedOptionsModal').find('#restartMessage button').click(function () {
            $(this).closest('.modal').modal('toggle');
            var json = {};
            json.method = 'restart';
            window.external.notify(JSON.stringify(json));
        });
    };
    // Write options in the choose path pulldown
    var $choosePathDropdown = $('#choosePathDropdown');
    $choosePathDropdown.next().empty();
    for (var j = 0; j < paths.length; j++) {
        if (j == path_index) continue;
        var $el = $('<a class="dropdown-item" href="javascript:void(null);" data-path-index="' + j + '">' + paths[j].title + '</a>').appendTo($choosePathDropdown.next());
        if (j == path_index) $el.addClass('active');
    };
    $choosePathDropdown.next().children().mousedown(function () {
        var $this = $(this);
        var index = parseInt($this.data('path-index'));
        var title = $this.text();
        $choosePathDropdown.data('path-index', index).text(title + ' ');
        $choosePathDropdown.next().children().removeClass('active');
        $choosePathDropdown.next().children('[data-path-index="' + index + '"]').addClass('active');
    });
    $('#choosePath').find('button:last').off('mousedown').mousedown(function () {
        var index = $choosePathDropdown.data('path-index');
        if ('undefined' != typeof (index)) {
            $.jStorage.set('commonplace_path_index', parseInt(index));
            $(this).closest('.modal').modal('toggle');
            var json = {};
            json.method = 'restart';
            window.external.notify(JSON.stringify(json));
        }
    });
}
// Provide information about the current project
function about_project() {
    var url = paths[path_index].contents[project_index].url;
    var human_url = url.replace('/index', '').replace(/^https?:\/\//, '').replace(/\/$/, '');
    var $modal = $('#aboutProjectModal');
    var $body = $modal.find('.modal-body');
    $body.empty();
    var $row = $('<div class="container-fluid"><div class="row"><div class="col"></div><div class="col"></div></div></div>').appendTo($body);
    $('<img src="' + paths[path_index].contents[project_index].thumb + '" class="thumb rounded" /><br />').appendTo($row.find('.col:first'));
    $('<p><b>' + paths[path_index].contents[project_index].title + '</b><br /><small>' + human_url + '</small></p>').appendTo($row.find('.col:first'));
    if (paths[path_index].contents[project_index].description) $('<p class="content">' + paths[path_index].contents[project_index].description + '</p>').appendTo($row.find('.col:first'));
    if (paths[path_index].contents[project_index].authors) $('<p class="content">By ' + paths[path_index].contents[project_index].authors + '</p>').appendTo($row.find('.col:first'));
    var str = '<p class="content">';
    if (paths[path_index].contents[project_index].institution) str += paths[path_index].contents[project_index].institution + '<br />';
    if (paths[path_index].contents[project_index].publisher) str += 'Published by ' + paths[path_index].contents[project_index].publisher;
    if (paths[path_index].contents[project_index].publisher && paths[path_index].contents[project_index].date) str += ', ';
    if (paths[path_index].contents[project_index].date) str += paths[path_index].contents[project_index].date;
    str += '</p>';
    $row.find('.col:first').append(str);    
    if (paths[path_index].contents[project_index].content) $('<p class="content">' + paths[path_index].contents[project_index].content + '</p>').appendTo($row.find('.col:last'));
    $modal.modal({ backdrop: 'static' });
    $modal.off('hidden.bs.modal').on('hidden.bs.modal', function (event) {
        child_timer(true);
    });
    child_timer(false);
}
// Ask for an email address then send the current project to it
function send_email() {
    var title = paths[path_index].contents[project_index].title;
    var url = paths[path_index].contents[project_index].url;
    var $modal = $('#emailModal');
    $modal.find('p:first').html('Send me<br /><b>' + title + '</b>');
    $modal.modal({backdrop:'static'});
    $modal.find('input[type="email"]').val('').keyboard();
    $modal.find('.btn-primary:last').click(function (event) {
        event.stopPropagation();
        var address = $modal.find('input[type="email"]').val();
        if (!address.length || -1 == address.indexOf('@') || -1 == address.indexOf('.')) {
            $modal.find('input[type="email"]').focus();
            return;
        };
        $('#emailModal').modal('hide');
        child_timer(true);
        var json = {};
        json.method = 'email';
        json.address = address;
        json.title = title;
        json.url = url;
        window.external.notify(JSON.stringify(json));
    });
    $modal.off('hidden.bs.modal').on('hidden.bs.modal', function (event) {
        child_timer(true);
    });
    child_timer(false);
}
// Restart the timer
function reset_timer(start) {
	if ('undefined'!=typeof(interval)) {
		clearInterval(interval);
		interval = null;
	}
	if ('undefined'==typeof(start)) start = 10;
	interval = setInterval(function() {
        start--;
		if (!start) {
			clearInterval(interval);
			interval = null;
			animate_next_project();
			return;
		};
	}, 1000);
};
// Stop timer
function stop_timer() {
    if ('undefined' != typeof (interval)) {
        clearInterval(interval);
        interval = null;
    }    
}
// Start/stop auto-navigate timer
function child_timer(bool) {
    if ('undefined' == typeof (bool)) bool = false;
    if (bool) {
        $('#site')[0].contentWindow.postMessage("autonavigate_reset_timer", '*');
    } else {
        $('#site')[0].contentWindow.postMessage("autonavigate_stop_timer", '*');
    };
}
// Set the popup panel's content based on the current project
function set_panel() {
	$('#panel .row:not(:first)').remove();
	$pathTitle = $('#panel .path-title:first');
	$pathTitle.find('.title').html(paths[path_index].title);
	$pathTitle.find('.desc').html(paths[path_index].desc);
    var $row = null;
    var colspan = 6;
    // Write project icons
	for (var j = 0; j < paths[path_index].contents.length; j++) {
        if (j == 0 || j % colspan == 0) $row = $('<div class="row"></div>').appendTo('#panel > div:first');
		var $cell = $('<div class="col"></div>').appendTo($row);
		$cell.data('project_index', j);
        if (j == project_index) $cell.addClass('hl');
        $('<img src="' + paths[path_index].contents[j].thumb + '" class="rounded" /><br />').appendTo($cell);
        $('<h6>' + paths[path_index].contents[j].title + '</h6>').appendTo($cell);
        if (paths[path_index].contents[j].institution) $cell.append('<p class="institution">'+paths[path_index].contents[j].institution+'</p>');
        var authors = (paths[path_index].contents[j].authors) ? paths[path_index].contents[j].authors : 'No authors listed';
        $authors = $('<p class="authors">By ' + authors + '</p>').appendTo($cell);
        $('<div class="gradient"><div>').appendTo($cell);
    };
    if (j % colspan != 0) {
        for (var k = (j % colspan); k < colspan; k++) {
            $cell = $('<div class="col empty">&nbsp;</div>').appendTo($row);
        };
    };
    // Clicking a project icon chooses that project
    $('#panel').find('.col').each(function () {
        var $this = $(this);
        if ($this.closest('header').length) return;
        $this.bind('click', function () {
            var index = parseInt($(this).data('project_index'));
            project_index = index - 1;
            next_project();
            $('#panel').fadeOut('slow');
        });
    });
    // Open and close the panel
    $('#logo-wrapper').off('mousedown').bind('mousedown', function() {
		var $panel = $('#panel');
		if ($panel.is(':visible')) {
            $panel.fadeOut('slow');
            if (project_index > -1) {
                set_messages(
                    '<a href="javascript:void(null);" class="btn-dotted">About this project</a>',
                    '<a href="javascript:void(null);" class="btn-dotted">Email this project</a>',
                    function (col) {
                        $(col).find('a:first').click(function () {
                            about_project();
                        });
                    },
                    function (col) {
                        $(col).find('a:last').click(function () {
                            send_email();
                        });
                    }
                );
            } else {
                set_messages('', '');
            }
            child_timer(true);
		} else {
            $panel.fadeIn('slow');
            set_messages(
                '<a href="javascript:void(null);" class="btn-dotted">About CommonPlace</a>',
                '<a href="javascript:void(null);" class="btn-dotted">Advanced options</a>',
                function (col) {
                    $(col).find('a:first').click(function () {
                        about_platform();
                    });
                },
                function (col) {
                    $(col).find('a:first').click(function () {
                        advanced_options();
                    });
                }
            );
            child_timer(false);
		};
    });
};
// Utils
function version_uri_to_content_uri(uri) {
	if (-1 == uri.indexOf('.')) return uri;
	uri = uri.substr(0, uri.lastIndexOf('.'));
	return uri;
};
function nl2br(str, is_xhtml) {  // http://kevin.vanzonneveld.net
  var breakTag = (is_xhtml || typeof is_xhtml === 'undefined') ? '<br ' + '/>' : '<br>';
  return (str + '').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1' + breakTag + '$2');
}
</script>
</head>
<body>
<iframe id="site" src=""></iframe>
<div id="panel">
    <div class="container-fluid">
        <header class="row">
            <div class="col path-title">
                <h2 class="title"></h2>
                <p class="desc"></p>
            </div>
        </header>
    </div>
</div>
<div id="nav" class="row">
    <div class="col" id="scroll-wrapper" data-toggle="tooltip" title="You can scroll projects with your finger"></div>
    <div class="col"></div>
    <div class="col text-center" id="logo-wrapper"></div>
    <div class="col"></div>
    <div class="col" id="pointer-wrapper" data-toggle="tooltip" title="Click on links and buttons to visit new pages"></div>
</div>
<div class="modal fade" id="aboutPlatformModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
        <div class="modal-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col">
                        <img src="common/css/Square44x44Logo.scale-400.png" class="thumb rounded" /><br />
                        <p>
                            <b>CommonPlace</b>
                            <small class="app_authors"></small>
                            <small class="version_num"></small>
                        </p>
                        <p class="content">
                            <span class="app_short_description"></span>
                        </p>
                    </div>
                    <div class="col">
                        <p class="content">
                            <span class="app_long_description"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="advancedOptionsModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title">Advanced options</h5>
          </div>
          <div class="modal-body">
              <!-- restart -->
              <p><button class="btn btn-default" type="button" data-toggle="collapse" data-target="#restartMessage" aria-expanded="false" aria-controls="restartMessage">Restart CommonPlace</button></p>
              <div class="collapse" id="restartMessage">
                  <div class="card card-body">
                      Restarting CommonPlace will reload the app with any new content that might exist in connected data sources. CommonPlace will then begin, as typical, with the first project in the default collection.<br />
                      <button class="btn btn-primary">Restart</button>
                  </div>
              </div>
              <p><button class="btn btn-default" type="button" data-toggle="collapse" data-target="#choosePath" aria-expanded="false" aria-controls="choosePath">Switch to a different collection</button></p>
              <div class="collapse" id="choosePath">
                  <div class="card card-body">
                      The connected data sources may contain multiple collections of projects. You can choose one below which will restart CommonPlace with the new collection set as the default.<br />
                      <div class="btn-group">
                          <div class="dropdown dropup">
                            <button class="btn btn-default dropdown-toggle" type="button" id="choosePathDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Choose a collection </button>
                            <div class="dropdown-menu" aria-labelledby="choosePathDropdown"></div>
                          </div>
                          &nbsp; &nbsp; 
                          <button type="button" class="btn btn-primary">Switch</button>
                      </div>
                  </div>
              </div>
              <!-- choose a new collection -->
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
      </div>
  </div>
</div>
<div class="modal fade" id="aboutProjectModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="emailModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <p></p>
        <form>
            <div class="form-group">
                <input type="email" class="keyboard form-control" placeholder="me@example.com">
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary">Send email</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>